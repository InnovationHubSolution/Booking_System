import express, { Request, Response } from 'express'; import Flight from '../models/Flight'; import { auth, AuthRequest } from '../middleware/auth'; const router = express.Router();// Search flightsrouter.get('/search', async (req: Request, res: Response) => {  try {    const {      from,      to,      departDate,      returnDate,      passengers = 1,      class: travelClass = 'economy',      stops,      maxPrice,      airlines,      sortBy = 'price'    } = req.query;    let query: any = { isActive: true };    // Required filters    if (from) query['departure.airport.code'] = from;    if (to) query['arrival.airport.code'] = to;    // Date filter    if (departDate) {      const startDate = new Date(departDate as string);      const endDate = new Date(startDate);      endDate.setHours(23, 59, 59, 999);      query['departure.dateTime'] = { $gte: startDate, $lte: endDate };    }    // Stops filter    if (stops) {      query.stops = stops === 'direct' ? 0 : { $gte: 1 };    }    // Price filter    if (maxPrice) {      query[`classes.${travelClass}.price`] = { $lte: parseFloat(maxPrice as string) };    }    // Airline filter    if (airlines) {      const airlineList = (airlines as string).split(',');      query['airline.code'] = { $in: airlineList };    }    // Check availability for travel class    query[`classes.${travelClass}.available`] = { $gte: parseInt(passengers as string) };    // Sorting    let sort: any = {};    switch (sortBy) {      case 'price':        sort[`classes.${travelClass}.price`] = 1;        break;      case 'duration':        sort.duration = 1;        break;      case 'departure':        sort['departure.dateTime'] = 1;        break;      default:        sort['departure.dateTime'] = 1;    }    const flights = await Flight.find(query).sort(sort);    // If return date, search return flights    let returnFlights: any[] = [];    if (returnDate && from && to) {      const returnStartDate = new Date(returnDate as string);      const returnEndDate = new Date(returnStartDate);      returnEndDate.setHours(23, 59, 59, 999);      const returnQuery = {        ...query,        'departure.airport.code': to,        'arrival.airport.code': from,        'departure.dateTime': { $gte: returnStartDate, $lte: returnEndDate }      };      returnFlights = await Flight.find(returnQuery).sort(sort);    }    res.json({      outbound: flights,      return: returnFlights,      searchParams: {        from,        to,        departDate,        returnDate,        passengers,        class: travelClass      }    });  } catch (error: any) {    res.status(500).json({ message: 'Error searching flights', error: error.message });  }});// Get flight by IDrouter.get('/:id', async (req: Request, res: Response) => {  try {    const flight = await Flight.findById(req.params.id);    if (!flight) {      return res.status(404).json({ message: 'Flight not found' });    }    res.json(flight);  } catch (error: any) {    res.status(500).json({ message: 'Error fetching flight', error: error.message });  }});// Get popular routesrouter.get('/routes/popular', async (req: Request, res: Response) => {  try {    const popularRoutes = await Flight.aggregate([      { $match: { isActive: true } },      {        $group: {          _id: {            from: '$departure.airport.code',            to: '$arrival.airport.code',            fromCity: '$departure.airport.city',            toCity: '$arrival.airport.city'          },          minPrice: { $min: '$classes.economy.price' },          flightCount: { $sum: 1 }        }      },      { $sort: { flightCount: -1 } },      { $limit: 10 }    ]);    res.json(popularRoutes);  } catch (error: any) {    res.status(500).json({ message: 'Error fetching popular routes', error: error.message });  }});// Admin: Create flightrouter.post('/', auth, async (req: AuthRequest, res: Response) => {  try {    if (req.user?.role !== 'admin') {      return res.status(403).json({ message: 'Admin access required' });    }    const flight = new Flight(req.body);    await flight.save();    res.status(201).json(flight);  } catch (error: any) {    res.status(500).json({ message: 'Error creating flight', error: error.message });  }});// Admin: Update flightrouter.put('/:id', auth, async (req: AuthRequest, res: Response) => {  try {    if (req.user?.role !== 'admin') {      return res.status(403).json({ message: 'Admin access required' });    }    const flight = await Flight.findByIdAndUpdate(req.params.id, req.body, { new: true });    if (!flight) {      return res.status(404).json({ message: 'Flight not found' });    }    res.json(flight);  } catch (error: any) {    res.status(500).json({ message: 'Error updating flight', error: error.message });  }});// Admin: Delete flightrouter.delete('/:id', auth, async (req: AuthRequest, res: Response) => {  try {    if (req.user?.role !== 'admin') {      return res.status(403).json({ message: 'Admin access required' });    }    const flight = await Flight.findByIdAndDelete(req.params.id);    if (!flight) {      return res.status(404).json({ message: 'Flight not found' });    }    res.json({ message: 'Flight deleted successfully' });  } catch (error: any) {    res.status(500).json({ message: 'Error deleting flight', error: error.message });  }});

export default router;
